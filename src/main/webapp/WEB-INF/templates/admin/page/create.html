<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" th:replace="layout::head('WallRide')" />
		<title>WallRide</title>
	</head>
	<body>
		<header th:replace="layout::header"></header>
		<div>
			<div th:replace="layout::sidebar"></div>
			<div id="main">
				<ol class="breadcrumb">
					<li><a th:href="@{__${ADMIN_PATH}__/}" th:text="#{Dashboard}">Dashboard</a></li>
					<li><a th:href="@{__${ADMIN_PATH}__/pages/index}" th:text="#{Pages}">Pages</a></li>
					<li class="active" th:text="#{AddNewPage}">Add new page</li>
				</ol>
				<form id="page-create-form" th:fragment="form(title,id)" th:action="@{__${ADMIN_PATH}__/pages/create}" th:object="${form}" action="#" method="post">
					<input type="hidden" name="id" th:if="${id} ne null" th:value="${id}"  />
					<div class="row">
						<div class="col-sm-9">
							<div class="page-header clearfix">
								<h1 th:text="${title}?:#{AddNewPage}">Add New Page</h1>
							</div>
							<div class="alert alert-success" th:if="${savedPage ne null}">
								<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
								<span th:text="#{SavedPage}">Page saved.</span>
							</div>
							<div class="alert alert-danger" th:if="${#fields.hasErrors('all')}">
								<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
								Error.
							</div>
							<fieldset>
								<div class="form-group">
									<div id="post-cover-dropzone" class="wr-post-cover-dropzone col-sm-12" style="">
										<p class="placeholder help-block" th:text="#{CoverImage}">Cover Image</p>
										<div class="dragover hide"><span class="help-block">Drop files here</span></div>
										<div th:classappend="${form.coverId}? '' : 'hide'" class="image-wrap">
											<img th:if="${form.coverId ne null}" th:src="@{${#medias.link(form.coverId)}(w=1200,h=500,m=1)}" class="wr-post-cover" />
											<div class="remove"><a href="#"><span class="glyphicon glyphicon-remove"></span></a></div>
										</div>
										<div class="progress hide"><div class="progress-bar progress-bar-success"></div></div>
										<input type="hidden" th:field="*{coverId}" />
									</div>
								</div>
								<script th:inline="javascript">
								$(function() {
									$('#post-cover-dropzone').fileupload({
										url: /*[[@{__${ADMIN_PATH}__/media/create.json}]]*/ '#',
										paramName: 'file',
										dropZone: $('#post-cover-dropzone'),
										dragover: function(e) {
											var dropZone = $('#post-cover-dropzone');
											var timeout = window.dropZoneTimeout;
											if (!timeout) {
												$('#post-cover-dropzone .dragover').removeClass('hide');
											} else {
												clearTimeout(timeout);
											}
											var found = false;
											var node = e.target;
											do {
												if (node === dropZone[0]) {
													found = true;
													break;
												}
												node = node.parentNode;
											} while (node != null);
											if (found) {
												$('#post-cover-dropzone .dragover').removeClass('hide');
											}
											else {
												$('#post-cover-dropzone .dragover').addClass('hide');
											}
											window.dropZoneTimeout = setTimeout(function () {
												window.dropZoneTimeout = null;
												$('#post-cover-dropzone .dragover').addClass('hide');
											}, 100);
										},
										start: function(e) {
											$('#post-cover-dropzone .progress').removeClass('hide');
										},
										progressall: function (e, data) {
											var progress = parseInt(data.loaded / data.total * 100, 10);
											$('#post-cover-dropzone .progress-bar').css('width', progress + '%');
										},
										done: function(e, data) {
											$('#post-cover-dropzone :input[name="coverId"]').val(data.result.id);
											$('#post-cover-dropzone .progress').addClass('hide');
											$('#post-cover-dropzone .progress-bar').css('width', '0%');
											var img = $('<img class="wr-post-cover" />').attr('src', data.result.filelink + '?' + $.param({w: 1200, h: 500, m: 1}));
											$('#post-cover-dropzone img').remove();
											$('#post-cover-dropzone').append(img);
											$('#post-cover-dropzone .image-wrap').removeClass('hide');
										}
									});
									$('#post-cover-dropzone .remove').click(function(e) {
										$('#post-cover-dropzone :input[name="coverId"]').val('');
										$('#post-cover-dropzone .image-wrap').addClass('hide');
										$('#post-cover-dropzone img').remove();
										e.preventDefault();
									});
								});
								</script>
							</fieldset>
							<fieldset>
								<div class="form-group" th:classappend="${#fields.hasErrors('title')}? has-error">
									<input type="text" th:field="*{title}" class="form-control" th:attr="placeholder=#{EnterTitle}" />
									<span class="help-block" th:each="err : ${#fields.errors('title')}" th:text="${err}" />
								</div>
							</fieldset>
							<fieldset>
								<div class="form-group" th:classappend="${#fields.hasErrors('code')}? has-error">
									<span th:text="${WEBSITE_LINK + '/'}"></span> <input type="text" th:field="*{code}" class="form-control input-sm wr-code" name="path" placeholder="URLパス" th:attr="placeholder=#{URLPath}" />
									<span class="help-block" th:each="err : ${#fields.errors('code')}" th:text="${err}" />
								</div>
							</fieldset>
							<fieldset>
								<div class="post-bodies">
									<fieldset th:each="body, stat : *{bodies}" class="post-body">
										<div class="form-group" th:classappend="${#fields.hasErrors('bodies')}? has-error">
											<textarea name="bodies" class="form-control" th:attr="placeholder=#{EnterBody}" placeholder="Enter body here"><span th:text="${body}"></span></textarea>
											<span class="help-block" th:each="err : ${#fields.errors('bodies')}" th:text="${err}" />
										</div>
									</fieldset>
									<a href="#" class="add-page"><span class="glyphicon glyphicon-plus"></span> ページ追加</a> &nbsp;&nbsp;&nbsp;
									<a href="#" class="delete-page"><span class="glyphicon glyphicon-remove"></span> ページ削除</a>
								</div>
								<script th:inline="javascript">
									/*<![CDATA[*/
									$(document).ready(function() {
										$('#main :input[name="bodies"]').redactor({
											minHeight: 300,
											convertImageLinks: true,
											convertVideoLinks: true,
											imageUpload: /*[[@{__${ADMIN_PATH}__/media/create.json}]]*/ '#',
											imageGetJson: /*[[@{__${ADMIN_PATH}__/media/index.json}]]*/ '#'
										});
										$('#page-create-form .add-page').on('click', function(e) {
											e.preventDefault();
											var target = $(this).prev('.post-body');
											var nextBody = $('<fieldset class="post-body">'+'<div class="form-group">'+'<textarea name="bodies" class="form-control">'+'<'+'/textarea>'+'<'+'/div>'+'<'+'/fieldset>');
											$(nextBody).insertAfter($(target)).hide().fadeIn(400);
											$('#main :input[name="bodies"]').redactor({
												minHeight: 300,
												convertImageLinks: true,
												convertVideoLinks: true,
												imageUpload: /*[[@{__${ADMIN_PATH}__/media/create.json}]]*/ '#',
												imageGetJson: /*[[@{__${ADMIN_PATH}__/media/index.json}]]*/ '#'
											});
										});
										$('#page-create-form').submit(function() {
											var disable = function(elements) {
												var empty = true;
												$(elements).each(function(i, element) {
													$(element).val($.trim($(element).val()));
													if ($(element).val() != '') {
														empty = false;
														return;
													}
												});
												if (empty) {
													$(elements).prop('disabled', true);
													$(elements).closest('.form-group').parent().removeClass('post-body');
												}
											};
											var replace = function(elements, index) {
												$(elements).each(function(i, element) {
													var name = $(element).attr("name");
													if (name) {
														var result = name.match(/\[.+?\]/g);
														name = name.replace(result[0], "[" + index + "]");
														$(element).attr("name", name);
													}
												});
												index++;
											};
											$('#page-create-form .post-body').each(function(i, detail) {
												disable($(':input', detail));
											});
											$('#page-create-form .post-body').each(function(i, detail) {
												replace($(':input:enabled', detail), i);
											});
										});
									});
									/*]]>*/
								</script>
							</fieldset>
						</div>
						<div class="col-sm-3 wr-tool-panel">
							<div class="tools clearfix">
								<div class="pull-left">
									<div class="btn-group">
										<button name="unpublish" class="btn btn-default" th:text="#{Unpublish}">Unpublish</button>
									</div>
								</div>
								<div class="pull-right">
									<div class="btn-group">
										<button name="publish" class="btn btn-primary" th:text="#{Publish}">Publish</button>
									</div>
								</div>
							</div>
							<div class="clearfix wr-tool-check">
								<div class="pull-left">
									<a id="page-preview" href="#"><span class="glyphicon glyphicon-eye-open"></span> <span th:text="#{Preview}">Preview</span></a>
								</div>
								<div class="pull-right">
									<div class="status" th:if="${page} ne null">
										<span th:if="${#strings.toString(page.status) eq 'UNPUBLISHED'}" class="glyphicon glyphicon-warning-sign"></span>
										<span th:if="${#strings.toString(page.status) eq 'SCHEDULED'}" class="glyphicon glyphicon-time"></span>
										<span th:if="${#strings.toString(page.status) eq 'PUBLISHED'}" class="glyphicon glyphicon-globe"></span>
										<span th:text="${#messages.msg('Post.Status.' + page.status)}">Published</span><br />
									</div>
								</div>
							</div>
							<script th:inline="javascript">
								$(function() {
									$('#main').on('click', '#page-preview', function(e) {
										e.preventDefault();
										var form = $(this).closest('form').clone();
										var action = /*[[@{__${ADMIN_PATH}__/pages/preview}]]*/ '#';
										form.attr('action', action);
										form.attr('target', '_blank');
										$(':input[name="body"]', form).val($('#main :input[name="body"]').redactor('get'));
										form.submit();
									});
								});
							</script>
							<fieldset>
								<legend th:text="#{Date}">公開日</legend>
								<div class="form-group row" th:classappend="${#fields.hasErrors('date')}? has-error">
									<div class="col-sm-12">
										<input type="text" name="date" th:value="*{date ne null ? date.toString('yyyy/MM/dd') : ''}" class="form-control" placeholder="yyyy/MM/dd"/>
									</div>
									<span class="help-block" th:each="err : ${#fields.errors('date')}" th:text="${err}" />
								</div>
							</fieldset>
							<fieldset>
								<legend th:text="#{ParentPage}">親ページ</legend>
								<div class="form-group">
									<select name="parentId" class="form-control" th:field="*{parentId}" >
										<option value="">Select Parent Page</option>
										<option th:each="page : ${pageTree.pages}" th:if="${page.id ne id}" th:value="${page.id}" th:text="${page.title}" th:selected="${page.id eq parentId}"></option>
									</select>
								</div>
							</fieldset>
							<fieldset id="seo-fieldset">
								<legend>META</legend>
								<div class="form-group" th:classappend="${#fields.hasErrors('metaKeywords')}? has-error">
									<textarea th:field="*{metaKeywords}" class="form-control" placeholder="Keywords"></textarea>
									<span th:if="${#fields.hasErrors('metaKeywords')}" class="help-block" th:text="${#fields.errors('metaKeywords')}" />
								</div>
								<div class="form-group" th:classappend="${#fields.hasErrors('metaDescription')}? has-error">
									<textarea th:field="*{metaDescription}" class="form-control" placeholder="Description" style="min-height: 100px"></textarea>
									<span th:if="${#fields.hasErrors('metaDescription')}" class="help-block" th:text="${#fields.errors('metaDescription')}" />
								</div>
							</fieldset>
						</div>
					</div>
				</form>
			</div>
		</div>
		<footer>
		</footer>
	</body>
</html>